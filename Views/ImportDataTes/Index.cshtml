@{
    ViewData["title"] = "tes import Data ";
}

<div class="content-wrapper">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h3>Kelola Data</h3>
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-sm btn-info mr-1" data-toggle="modal" data-target="#importModal">Import Data</button>
                            <button type="button" id="btnHapus" class="btn btn-sm btn-danger">Hapus Semua Data</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <div id="table"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      
    </div>
  </div>
</div>

@* form modal import data *@
<div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-labelledby="importModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Import Data</h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Tutup">
        <span aria-hidden="true">&times;</span>
    </button>
      </div>
      <div class="modal-body">
        <form id="formImport" method="post" enctype="multipart/form-data">
            @Html.AntiForgeryToken()

            <div class="form-group m-2">
                <label for="importFile">Import File</label>
                <input type="file" name="formFile" class="form-control" accept=".csv" required>
                <small class="text-danger">Formal File csv</small>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
        <a href=""></a>
      </div>
    </div>
  </div>
</div>

@section Scripts
{
    <script>
        $(function() {
            $("#table").dxDataGrid({
                dataSource: {
                    store: {
                        type: "odata",
                        version: 4,
                        url: "/odata/ApiTesImport",
                        key: "Id"
                    }
                },
                paging: {
                    pageSize: 10
                },
                pager: {
                    showPageSizeSelector: true,
                    allowedPageSizes: [10, 20, 50],
                    showInfo: true
                },
                filterRow: {
                    visible: true
                },
                searchPanel: {
                    visible: true,
                    width: 240,
                    placeholder: "Cari..."  
                },
                columns: [
                    {
                        dataField: "Id",
                        visible: false,
                        sortOrder: "desc", 
                        sortIndex: 0       
                    },
                    {
                        caption: "No",
                        cellTemplate: function (container, options) {
                            const pageIndex = $("#table").dxDataGrid("instance").pageIndex();
                            const pageSize = $("#table").dxDataGrid("instance").pageSize();
                            const globalIndex = (pageIndex * pageSize) + options.rowIndex + 1;
                            container.text(globalIndex);
                        },
                        width: 50
                    },
                    { 
                        dataField: "KdSatker", 
                        caption: "KD SATKER" 
                    },
                    {
                        dataField: "KdCoa", 
                        caption: "KD COA" 
                    },
                    {
                        dataField: "Pagu", 
                        caption: "PAGU" 
                    },
                    {
                        dataField: "Realisasi", 
                        caption: "REALISASI"
                    },
                    {
                        dataField: "SisaPagu", 
                        caption: "SISA PAGU" 
                    },
                ] 
            });
        });

        $(document).on("submit", "#formImport", function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            if ($("#custom-loader").length === 0) {
                $("body").append(`
                    <div id="custom-loader" style="position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%;
                        background-color: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                `);
            }

            $("#custom-loader").show();

            $.ajax({
                url: "@Url.Action("ImportFile", "TesImport")",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    alert(response.pesan);
                    $("#table").dxDataGrid("instance").refresh();
                    $("#importModal").modal("hide");
                },
                error: function(xhr, status, code) {
                    const json = JSON.parse(xhr.responseText); 
                    alert(json.pesan); 
                },
                complete: function() {
                    // Sembunyikan loader setelah request selesai
                    $("#custom-loader").hide();
                }
            });
        });

        $(document).on("click", "#btnHapus", function(e) {
            e.preventDefault();

            if(confirm("Yakin ingin hapus semua data?")) {

                if ($("#custom-loader").length === 0) {
                $("body").append(`
                    <div id="custom-loader" style="position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%;
                        background-color: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                `);
            }

            $("#custom-loader").show();


                $.ajax({
                    url: "@Url.Action("deleteSemua", "TesImport")",
                    type: "GET",
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        alert(response.pesan);

                        $("#table").dxDataGrid("instance").refresh();
                        $("#importModal").modal("hide");
                    },
                    error: function(xhr, status, code) {
                        const json = JSON.parse(xhr.responseText); 
                        alert(json.pesan);
                    },
                    complete: function() {
                        $("#custom-loader").hide();
                    }
                });
            }           
        })
    </script>
}
