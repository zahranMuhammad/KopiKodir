@using Microsoft.AspNetCore.Http;
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Delivery</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      background-color: #f8f9fa;
      font-family: Arial, sans-serif;
    }

    .table-container {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .table-title {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .table-title h2 {
      margin-bottom: 10px;
      font-weight: 600;
      color: #333;
    }

    @@media (max-width: 576px) {
      .table-title {
        flex-direction: column;
        align-items: flex-start;
      }

      .table-title select {
        width: 100%;
      }
    }

    .table th {
      background-color: #343a40;
      color: #fff;
    }

    .form-select {
      min-width: 150px;
    }
  </style>
</head>
<body>
  
  <!-- Loader Spinner -->
  <div id="loader" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex justify-content-center align-items-center" style="z-index: 1050;">
      <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
      </div>
  </div>

  <div class="container">
    <div class="table-container">
      <div class="table-title">
        <div class="d-flex justify-content-between mb-1 w-100">
          <h2>Data Delivery</h2>
          @{
            var email = Context.Session.GetString("Email");
          }
          <a href="/Auth/Logout/@email" class="btn btn-danger d-flex align-items-center" onclick="return confirm('Yakin ingin logout?')">Logout</a>
        </div>
        <select class="form-select" aria-label="Filter status" id="filterStatus">
          <option selected>All Status</option>
          <option value="1">Sudah Sampai</option>
          <option value="2">Sedang Dalam Perjalanan</option>
        </select>
      </div>

      <div class="table-responsive">
        <div id="tableDelivery">

        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="confirmForm">
            @Html.AntiForgeryToken()

            <div class="modal-header">
              <h5 class="modal-title" id="confirmModalLabel">Konfirmasi Pengiriman</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="deliveryId" name="transaksiId">
              <div class="mb-3">
                <label for="jumlahBayar" class="form-label">Jumlah Bayar</label>
                <input type="number" class="form-control" id="jumlahBayar" name="JumlahBayar" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Submit</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>

 <!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DevExtreme Core CSS & JS -->
<link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/23.2.3/css/dx.light.css">
<script src="https://cdn3.devexpress.com/jslib/23.2.3/js/dx.all.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
      $(function() {
          $("#tableDelivery").dxDataGrid({
              dataSource: {
                  store: {
                      type: "odata",
                      version: 4,
                      url: "/odata/ApiDeliver?$expand=user",
                      key: "Id"
                  }
              },
              paging: {
                  pageSize: 10
              },
              pager: {
                  showPageSizeSelector: true,
                  allowedPageSizes: [10, 20, 50],
                  showInfo: true
              },
              filterRow: {
                  visible: true
              },
              searchPanel: {
                  visible: true,
                  width: 240,
                  placeholder: "Cari..."  
              },
              columns: [
                  {
                      dataField: "Id",
                      visible: false,
                      sortOrder: "desc", 
                      sortIndex: 0       
                  },
                  {
                      caption: "No",
                      cellTemplate: function (container, options) {
                          container.text(options.rowIndex + 1);
                      },
                      width: 50
                  },
                  { 
                      dataField: "Tanggal", 
                      caption: "Tanggal" 
                  },
                  { 
                      dataField: "user.Nama", 
                      caption: "Nama Pembeli" 
                  },
                  {
                      dataField: "Nominal",
                      caption: "Nominal Belanja",
                      format: {
                          type: "currency",
                          precision: 0,
                          currency: "IDR" 
                      }
                  },
                  {
                      dataField: "JumlahBayar",
                      caption: "Jumlah Bayar",
                      format: {
                          type: "currency",
                          precision: 0,
                          currency: "IDR" 
                      }
                  },
                  { 
                      dataField: "MetodePembayaran", 
                      caption: "Metode Pembayaran" 
                  },                    
                  { 
                      dataField: "Status", 
                      caption: "Status" 
                  },
                  { 
                      dataField: "TanggalSampai", 
                      caption: "Tanggal Sampai" 
                  },
                  {
                      caption: "Aksi",
                      cellTemplate: function (container, options) {
                          const id = options.data.Id;
                          const jumlahBayar = options.data.JumlahBayar;
                          if(jumlahBayar == 0) {
                            const div = $("<div>");
                                div.append(`<button class="btn btn-sm btn-primary mr-1" onclick="openDetailModal(${id})">Sudah Sampai?</button>`);
                            container.append(div);
                          }
                      },
                      width: 160
                  }
              ] 
          });
      });

      function openDetailModal(id) {
        const grid = $("#tableDelivery").dxDataGrid("instance");
        const rowData = grid.getVisibleRows().find(row => row.data.Id === id)?.data;

        if (rowData) {
          $("#deliveryId").val(rowData.Id);
          $("#jumlahBayar").val(rowData.JumlahBayar); 
          const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
          modal.show();
        }
      }

      $(document).on('submit', '#confirmForm', function(e) {
        e.preventDefault();

        const dataForm = new FormData(this);

        const inputJumlahBayar = document.getElementById("jumlahBayar").value;

        if(inputJumlahBayar == 0 || inputJumlahBayar == null) {
          alert("Harap isi jumlah Bayar Dengan Benar");
          return;
        }

        $("#loader").removeClass("d-none");

        $.ajax({
          url: '@Url.Action("UpdateTransaksi", "Deliver")',
          type: 'POST',
          data: dataForm,
          processData: false,
          contentType: false,
          success: function(response) {
            alert(response.pesan);

            $("#tableDelivery").dxDataGrid("instance").refresh();
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            modal.hide();

          },
          error: function(xhr, status, code) {
            const res = JSON.parse(xhr.responseText);
            alert("Gagal: " + res.pesan);
          },
          complete: function() {
            $('#loader').addClass("d-none");
          }
        });

      });
  </script>


</body>
</html>


